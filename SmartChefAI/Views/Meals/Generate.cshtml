@model MealGenerationRequestViewModel

@{
    var mode = (string?)(ViewData["Mode"] ?? "dummy");
    var isChefMode = string.Equals(mode, "chef", StringComparison.OrdinalIgnoreCase);
    var heroTitle = (string?)(ViewData["ModeTitle"] ?? "Generate a Smart Meal");
    var heroSubtitle = (string?)(ViewData["ModeSubtitle"] ?? "Tell the assistant what you have on hand and your calorie goal.");
    var actionName = (string?)(ViewData["ModePrimaryAction"] ?? "DummyAi");
    ViewData["Title"] = heroTitle;

    var heroHighlights = isChefMode
        ? new[]
        {
            "Real nutrition lookup + Gemini meal ideas",
            "Auto-adjusts macros toward your calorie goal",
            "Best for detailed ingredient lists"
        }
        : new[]
        {
            "Lightning-fast mock ideas for demos",
            "Simulated macros for quick testing",
            "Great when you only have one ingredient"
        };

    var helperTitle = isChefMode ? "ChefAI best practices" : "Dummy AI shortcuts";
    var helperBullets = isChefMode
        ? new[]
        {
            "List ingredients with quantity + unit for more accurate macros.",
            "Toggle the calorie target checkbox if you want ChefAI to use your saved goal.",
            "Expect a short pause while Gemini thinks—watch the tracker update after saving."
        }
        : new[]
        {
            "One ingredient is enough; we'll pair it with staples automatically.",
            "Use it for ideation before switching to ChefAI for precise macros.",
            "Save meals to build your library even from mock outputs."
        };
}

<section class="mode-hero animate-panel @(isChefMode ? "chef" : "dummy")">
    <div class="animate-fade">
        <div class="mode-chip">
            <span class="dot"></span>
            @(isChefMode ? "ChefAI • Vertex Powered" : "Dummy AI • Simulated")
        </div>
        <h1 class="mb-3">@heroTitle</h1>
        <p class="lead mb-4">
            @heroSubtitle
        </p>
        <ul class="feature-list">
            @foreach (var highlight in heroHighlights)
            {
                <li>@highlight</li>
            }
        </ul>
        <div class="hero-actions">
            <a asp-controller="Meals" asp-action="Saved" class="btn btn-outline-light">View saved meals</a>
            <a asp-controller="Home" asp-action="Index" class="btn btn-link text-white text-decoration-underline">
                Dashboard
            </a>
        </div>
    </div>
    <div class="hero-card animate-fade delay-1">
        <p class="text-muted mb-1">Session tips</p>
        <ul class="list-unstyled mb-0 small">
            <li>• Ingredients update instantly—no need to reload.</li>
            <li>• Removing an ingredient keeps nutrition balanced.</li>
            <li>• Save &amp; apply to update the daily tracker.</li>
        </ul>
    </div>
</section>

<div class="row g-4 mb-4">
    <div class="col-md-6">
        <div class="glass-card h-100 animate-slide-up">
            <div class="card-body">
                <h5 class="card-title">@helperTitle</h5>
                <ul class="list-unstyled mb-0">
                    @foreach (var tip in helperBullets)
                    {
                        <li>• @tip</li>
                    }
                </ul>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="glass-card h-100 animate-slide-up delay-1">
            <div class="card-body">
                <h5 class="card-title">Need ingredient ideas?</h5>
                <p class="card-text">
                    Think in trios: hero protein or veg, hearty filler (grains, legumes), and a brightness booster
                    (citrus, herbs, yogurt). ChefAI fills gaps automatically, but solid anchors speed up generation.
                </p>
                <div class="d-flex flex-wrap gap-2">
                    <span class="badge-nutrition">Protein + Grain</span>
                    <span class="badge-nutrition">Veg + Healthy fat</span>
                    <span class="badge-nutrition">Spice blend</span>
                </div>
            </div>
        </div>
    </div>
</div>

@if (ViewData["ModeWarnings"] is IEnumerable<string> warnings && warnings.Any())
{
    foreach (var warning in warnings)
    {
        <div class="alert alert-warning">@warning</div>
    }
}

@if (TempData["Error"] is string errorMessage)
{
    <div class="alert alert-danger">@errorMessage</div>
}

<form asp-action="@actionName" method="post" class="needs-validation" novalidate>
    @Html.AntiForgeryToken()
    <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>

    <fieldset class="ingredient-fieldset animate-slide-up">
        <legend class="float-none w-auto px-2 fw-semibold">Ingredients</legend>
        <div class="row g-3">
            @for (var i = 0; i < Model.Ingredients.Count; i++)
            {
                <div class="col-12">
                    <div class="card ingredient-card animate-slide-up @(i % 2 == 0 ? string.Empty : "delay-1")">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h6 class="mb-0">Ingredient @(i + 1)</h6>
                                @if (Model.Ingredients.Count > 1)
                                {
                                    <button class="btn btn-sm btn-outline-danger" type="submit" name="submitAction" value="removeIngredient"
                                            formaction="@Url.Action(actionName, "Meals")" formmethod="post"
                                            onclick="document.getElementById('remove-index').value='@i'">
                                        Remove
                                    </button>
                                }
                            </div>
                            <div class="row g-2">
                                <div class="col-12 col-lg-6">
                                    <label asp-for="Ingredients[i].Name" class="form-label">Ingredient name</label>
                                    <input asp-for="Ingredients[i].Name" class="form-control" placeholder="e.g. Chicken breast, Spinach" />
                                    <span asp-validation-for="Ingredients[i].Name" class="text-danger small"></span>
                                </div>
                                <div class="col-6 col-lg-3">
                                    <label asp-for="Ingredients[i].Quantity" class="form-label">Quantity</label>
                                    <input asp-for="Ingredients[i].Quantity" class="form-control" placeholder="e.g. 150" />
                                    <span asp-validation-for="Ingredients[i].Quantity" class="text-danger small"></span>
                                </div>
                                <div class="col-6 col-lg-3">
                                    <label asp-for="Ingredients[i].Unit" class="form-label">Unit</label>
                                    <input asp-for="Ingredients[i].Unit" class="form-control" placeholder="g, cup, tbsp" />
                                    <span asp-validation-for="Ingredients[i].Unit" class="text-danger small"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
        <div class="mt-3">
            <button class="btn btn-outline-primary" type="submit" name="submitAction" value="addIngredient">
                <span class="me-1">+</span>Add another ingredient
            </button>
        </div>
    </fieldset>

    <div class="row g-3 mb-4">
        <div class="col-md-6 col-lg-4">
            <label asp-for="CalorieTarget" class="form-label">Calorie target for this meal</label>
            <div class="input-group">
                <input asp-for="CalorieTarget" class="form-control" placeholder="e.g. 600" />
                <span class="input-group-text">kcal</span>
            </div>
            <span asp-validation-for="CalorieTarget" class="text-danger small"></span>
        </div>
        <div class="col-md-6 col-lg-4 d-flex align-items-center">
            <div class="form-check mt-4">
                <input asp-for="UseUserCalorieTarget" class="form-check-input" />
                <label asp-for="UseUserCalorieTarget" class="form-check-label">
                    Use my saved daily calorie goal
                </label>
            </div>
        </div>
    </div>

    <input type="hidden" id="remove-index" name="removeIndex" value="-1" />

    <div class="form-cta animate-slide-up">
        <button class="btn btn-primary" type="submit" name="submitAction" value="generate">
            Generate Meal
        </button>
        <a class="btn btn-outline-secondary" asp-controller="Meals" asp-action="Saved">View saved meals</a>
    </div>
</form>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        (function () {
            const checkbox = document.getElementById("@Html.IdFor(m => m.UseUserCalorieTarget)");
            const calorieInput = document.getElementById("@Html.IdFor(m => m.CalorieTarget)");

            function toggleCalorieInput() {
                if (!checkbox || !calorieInput) return;
                const readOnly = checkbox.checked;
                calorieInput.readOnly = readOnly;
                calorieInput.classList.toggle("bg-light", readOnly);
                if (readOnly) {
                    calorieInput.setAttribute("title", "Using your saved daily target");
                } else {
                    calorieInput.removeAttribute("title");
                }
            }

            if (checkbox) {
                checkbox.addEventListener("change", toggleCalorieInput);
                toggleCalorieInput();
            }

            // Reset hidden remove index after each submission to avoid accidental removals.
            document.querySelectorAll("form button[type='submit']").forEach(btn => {
                btn.addEventListener("click", function () {
                    const hidden = document.getElementById("remove-index");
                    if (hidden && this.value !== "removeIngredient") {
                        hidden.value = "-1";
                    }
                });
            });
        })();
    </script>
}
